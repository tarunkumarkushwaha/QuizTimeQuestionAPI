<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Quiz Manager</title>
</head>

<body style="font-family: Arial; background:#f4f6f9; margin:0; padding:20px;">

  <h1 style="text-align:center; color:#333;">Quiz Manager</h1>
  <a style="top: 20px; right: 30px; position: absolute; color:#f70505;" href="/logout">Logout</a>


  <div
    style="background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:20px;">
    <h2 id="formTitle" style="margin-bottom:10px; color:#444;">+ Add Question</h2>
    <form id="questionForm" onsubmit="submitQuestion(event)">
      <input type="hidden" id="editingId">

      <input type="text" id="question" placeholder="Enter question" required
        style="display:block; margin:8px 0; padding:10px; width:95%; border:1px solid #ccc; border-radius:5px;">
      <input type="text" id="option1" placeholder="Option 1" required
        style="display:block; margin:8px 0; padding:10px; width:95%; border:1px solid #ccc; border-radius:5px;">
      <input type="text" id="option2" placeholder="Option 2" required
        style="display:block; margin:8px 0; padding:10px; width:95%; border:1px solid #ccc; border-radius:5px;">
      <input type="text" id="option3" placeholder="Option 3" required
        style="display:block; margin:8px 0; padding:10px; width:95%; border:1px solid #ccc; border-radius:5px;">
      <input type="text" id="option4" placeholder="Option 4" required
        style="display:block; margin:8px 0; padding:10px; width:95%; border:1px solid #ccc; border-radius:5px;">
      <input type="text" id="correctresponse" placeholder="Correct Answer" required
        style="display:block; margin:8px 0; padding:10px; width:95%; border:1px solid #ccc; border-radius:5px;">
      <input type="number" id="time" placeholder="Time (seconds)" required
        style="display:block; margin:8px 0; padding:10px; width:95%; border:1px solid #ccc; border-radius:5px;">
      <input type="text" id="subject" placeholder="Subject name" required
        style="display:block; margin:8px 0; padding:10px; width:95%; border:1px solid #ccc; border-radius:5px;">

      <button type="submit" id="submitBtn"
        style="padding:10px 20px; background:#2196F3; color:#fff; border:none; border-radius:5px; cursor:pointer;">
        Add Question
      </button>
      <button type="button" id="cancelEditBtn" onclick="cancelEdit()"
        style="display:none; margin-left:10px; padding:10px 20px; background:#777; color:#fff; border:none; border-radius:5px; cursor:pointer;">
        Cancel
      </button>
    </form>
  </div>

  <!-- Question List -->
  <div style="position: relative;">
    <div style="margin-bottom:1rem;">
      <label for="collection-select"
        style="display:block; font-size:0.875rem; font-weight:500; color:#374151; margin-bottom:0.5rem;">
        Available Subjects:
      </label>
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="collection-select"
          style="flex:1; padding:0.5rem 1rem; font-size:1rem; border:1px solid #d1d5db; border-radius:0.375rem;">
          <option id="message-display" value="" disabled selected>Loading subjects...</option>
        </select>
        <button id="delete-subject-btn"
          style="padding:0.5rem 0.75rem; background:#e74c3c; color:#fff; border:none; border-radius:0.375rem; cursor:pointer;">
          X
        </button>
      </div>
    </div>

  </div>

  <div style="background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
    <h2 style="margin-bottom:10px; color:#444;">Questions</h2>
    <div id="questionList"></div>
  </div>

  <script>
    const API_URL = "http://localhost:3000";
    let allsubject = []
    let selectedSubject = "css"

    async function submitQuestion(e) {
      e.preventDefault();

      const subjectInput = document.getElementById("subject").value.trim();
      const subject = subjectInput !== "" ? subjectInput : selectedSubject;

      if (!subject) {
        alert("Please enter or select a subject");
        return;
      }

      const data = {
        question: document.getElementById("question").value,
        option1: document.getElementById("option1").value,
        option2: document.getElementById("option2").value,
        option3: document.getElementById("option3").value,
        option4: document.getElementById("option4").value,
        correctresponse: document.getElementById("correctresponse").value,
        time: parseInt(document.getElementById("time").value),
      };

      const editingId = document.getElementById("editingId").value;

      let url = `${API_URL}/quiz/${subject}`;
      let method = "POST";

      if (editingId) {
        url = `${API_URL}/quiz/${subject}/${editingId}`;
        method = "PUT";
      }

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        alert(editingId ? "Question updated!" : "Question added!");

        // Refresh subjects & questions
        selectedSubject = subject;
        await getAllSubjects();
        loadQuestions(subject);

        document.getElementById("questionForm").reset();
        resetFormState();
      } else {
        alert("Error saving question");
      }
    }

    async function loadQuestions() {
      const res = await fetch(`${API_URL}/quiz/${selectedSubject}`);
      const questions = await res.json();
      // console.log(questions)
      const list = document.getElementById("questionList");
      list.innerHTML = "";
      questions.forEach(q => {
        const div = document.createElement("div");
        div.style = "padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:5px; background:#fafafa;";
        div.innerHTML = `
        <b>${q.question}</b><br>
        1. ${q.option1} <br>
        2. ${q.option2} <br>
        3. ${q.option3} <br>
        4. ${q.option4} <br>
        Correct: ${q.correctresponse} <br>
        Time: ${q.time}s
        <br>
        <button onclick="editQuestion('${selectedSubject}', '${q._id}')"
        style="margin-top:5px; padding:5px 10px; background:#f39c12; color:#fff; border:none; border-radius:5px; cursor:pointer;">Edit</button>
        <button onclick="deleteQuestion('${selectedSubject}','${q._id}')"
        style="margin-top:5px; margin-left:5px; padding:5px 10px; background:#e74c3c; color:#fff; border:none; border-radius:5px; cursor:pointer;">Delete</button>
      `;
        list.appendChild(div);
      });
    }

    async function deleteQuestion(subject, id) {
      if (!confirm("Delete this question?")) return;
      const res = await fetch(`${API_URL}/quiz/delete/${subject}/${id}`, {
        method: "DELETE"
      });
      if (res.ok) {
        alert("Deleted!");
        loadQuestions(subject);
        //  setTimeout(() => {
        //   window.location.reload()
        // }, 2000);
      } else {
        alert("Error deleting question");
      }
    }

    async function getAllSubjects() {
      const selectElement = document.getElementById('collection-select');
      selectElement.innerHTML = ""; // clear old options

      const res = await fetch(`${API_URL}/quiz/allsubjects`);
      if (res.ok) {
        allsubject = await res.json();

        // Default option
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.textContent = "Select subject";
        selectElement.appendChild(defaultOption);

        // Add subjects
        allsubject.subjectss.forEach(collectionName => {
          const option = document.createElement("option");
          option.value = collectionName;
          option.textContent = collectionName;
          if (collectionName === selectedSubject) option.selected = true;
          selectElement.appendChild(option);
        });
      } else {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "No subjects found";
        option.disabled = true;
        selectElement.appendChild(option);
      }
    }

    document.getElementById("collection-select").addEventListener("change", (event) => {
      selectedSubject = event.target.value;
      loadQuestions();
    });

    // delete current subject
    document.getElementById("delete-subject-btn").addEventListener("click", async () => {
      if (!selectedSubject) {
        alert("Select a subject first!");
        return;
      }

      if (!confirm(`Delete subject "${selectedSubject}"? This will remove all its questions.`)) return;

      const res = await fetch(`${API_URL}/quiz/${selectedSubject}`, { method: "DELETE" });

      if (res.ok) {
        alert(`Subject "${selectedSubject}" deleted!`);
        selectedSubject = "";
        getAllSubjects(); // reload subjects
        document.getElementById("questionList").innerHTML = "";
      } else {
        alert("Error deleting subject");
      }
    });


    function selectSubject(name) {
      selectedSubject = name;
      loadQuestions();
    }

async function deleteSubject(name) {
  if (!confirm(`Delete subject "${name}"? This will remove all its questions.`)) return;

  const res = await fetch(`${API_URL}/quiz/${name}`, { method: "DELETE" });

  if (res.ok) {
    alert(`Subject "${name}" deleted!`);

    if (selectedSubject === name) {
      selectedSubject = "";
      document.getElementById("questionList").innerHTML = "";
    }

    await getAllSubjects();
  } else {
    alert("Error deleting subject");
  }
}
    async function editQuestion(subject, id) {
      const res = await fetch(`${API_URL}/quiz/${subject}/${id}`);
      const q = await res.json();

      document.getElementById("editingId").value = id;
      document.getElementById("formTitle").innerText = "âœŽ Edit Question";
      document.getElementById("submitBtn").innerText = "Update Question";
      document.getElementById("cancelEditBtn").style.display = "inline-block";

      document.getElementById("question").value = q.question;
      document.getElementById("option1").value = q.option1;
      document.getElementById("option2").value = q.option2;
      document.getElementById("option3").value = q.option3;
      document.getElementById("option4").value = q.option4;
      document.getElementById("correctresponse").value = q.correctresponse;
      document.getElementById("time").value = q.time;
      document.getElementById("subject").value = subject;
    }

    function cancelEdit() {
      document.getElementById("questionForm").reset();
      resetFormState();
    }

    function resetFormState() {
      document.getElementById("editingId").value = "";
      document.getElementById("formTitle").innerText = "+ Add Question";
      document.getElementById("submitBtn").innerText = "Add Question";
      document.getElementById("cancelEditBtn").style.display = "none";
    }

    loadQuestions();
    getAllSubjects()

    let selectElement = document.getElementById("collection-select")

    selectElement.addEventListener('change', (event) => {
      selectedSubject = event.target.value;
      loadQuestions()
    });
  </script>

</body>

</html>